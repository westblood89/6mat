<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Matematik Ligi Yönetim Sistemi – Realtime</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .qualified { background-color: #dcfce7 !important; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-4">
        <div class="text-4xl mr-4">🎒</div>
        <div class="text-center">
          <h1 class="text-3xl font-bold text-indigo-800 mb-2">🏆 Matematik Ligi</h1>
          <div class="text-center">
            <span class="text-gray-600 font-medium text-xl">Grup Aşaması</span>
          </div>
        </div>
        <div class="text-4xl ml-4">📚</div>
      </div>
      <div class="flex justify-center items-center space-x-4 text-2xl">
        <span>✏️</span>
        <span>📝</span>
        <span>🧮</span>
        <span>📐</span>
        <span>📏</span>
        <span>🔢</span>
        <span>➕</span>
        <span>➖</span>
        <span>✖️</span>
        <span>➗</span>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="flex flex-wrap border-b">
        <button onclick="showTab('standings', this)" class="tab-btn px-4 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600">
          📊 Puan Durumu
        </button>
        <button onclick="showTab('fixtures', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          📅 Fikstür
        </button>
        <button onclick="showTab('groups', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          👥 Gruplar
        </button>
      </div>
    </div>

    <!-- Standings Tab -->
    <div id="standings" class="tab-content active">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Puan Durumu</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="standingsGroupSelect" onchange="showStandings()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div id="standingsContent"></div>
      </div>
    </div>

    <!-- Fixtures Tab -->
    <div id="fixtures" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Fikstür ve Sonuçlar</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="fixtureGroupSelect" onchange="showFixtures()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div id="fixtureContent"></div>
      </div>
    </div>

    <!-- Groups Tab -->
    <div id="groups" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Grup Üyeleri</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="groupsGrid"></div>
        <div class="mt-6 text-center space-x-4">
          <button onclick="saveGroups()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium">
            💾 Grupları Kaydet
          </button>
          <button onclick="showBulkAdd()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
            📋 Toplu Ekle
          </button>
        </div>

        <!-- Bulk Add Modal -->
        <div id="bulkAddModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
              <h3 class="text-lg font-bold mb-4">Toplu İsim Ekleme</h3>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
                <select id="bulkGroupSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                  <option value="">Grup seçin...</option>
                </select>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">İsimleri yapıştırın (her satırda bir isim):</label>
                <textarea id="bulkNamesInput" placeholder="Ahmet\nMehmet\nAyşe\nFatma\n..." class="w-full h-32 border border-gray-300 rounded-lg px-3 py-2 resize-none" rows="6"></textarea>
              </div>
              <div class="flex space-x-3">
                <button onclick="addBulkNames()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">✅ Ekle</button>
                <button onclick="closeBulkAdd()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">❌ İptal</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase v10+ via ESM CDN -->
  <script type="module">
    // --- 1) Firebase Kurulumu ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // 👉 BURAYI KENDİ PROJE BİLGİLERİNLE DOLDUR (Firebase Console > Project settings > Web app)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Tüm lig verilerini tek bir dokümanda tutacağız
    const leagueDocRef = doc(db, "mathLeague", "default");

    // --- 2) Uygulama Durumu ---
    let leagueData = { groups: {}, fixtures: {}, results: {} };
    let unsub = null; // real-time listener

    // Grupları sayfaya çizen yardımcı
    function initializeGroups() {
      const groupsContainer = document.getElementById('groupsGrid');
      groupsContainer.innerHTML = '';
      for (let i = 1; i <= 14; i++) {
        const memberCount = i === 14 ? 6 : 8; // N grubu 6 kişilik
        const groupLetter = String.fromCharCode(64 + i); // A..N
        if (!leagueData.groups[groupLetter]) {
          leagueData.groups[groupLetter] = Array(memberCount).fill('');
        }
        const groupDiv = document.createElement('div');
        groupDiv.className = 'border border-gray-200 rounded-lg p-4';
        groupDiv.innerHTML = `
          <h3 class="font-bold text-lg mb-3 text-indigo-700">Grup ${groupLetter}</h3>
          ${Array(memberCount).fill(0).map((_, j) => `
            <input type="text" placeholder="Üye ${j + 1}" value="${leagueData.groups[groupLetter][j] || ''}"
              onchange="updateGroupMember('${groupLetter}', ${j}, this.value)"
              class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          `).join('')}
        `;
        groupsContainer.appendChild(groupDiv);
      }
    }

    // Açılır menüleri doldur
    function populateGroupSelects() {
      const fixtureSelect = document.getElementById('fixtureGroupSelect');
      const standingsSelect = document.getElementById('standingsGroupSelect');
      const bulkSelect = document.getElementById('bulkGroupSelect');
      fixtureSelect.innerHTML = '<option value="">Grup seçin...</option>';
      standingsSelect.innerHTML = '<option value="">Grup seçin...</option>';
      if (bulkSelect) bulkSelect.innerHTML = '<option value="">Grup seçin...</option>';
      Object.keys(leagueData.groups).forEach(group => {
        for (const select of [fixtureSelect, standingsSelect, bulkSelect]) {
          if (!select) continue;
          const opt = document.createElement('option');
          opt.value = group; opt.textContent = `Grup ${group}`; select.appendChild(opt);
        }
      });
    }

    // --- 3) Firestore'dan yükle & gerçek zamanlı dinle ---
    async function startRealtime() {
      const snap = await getDoc(leagueDocRef);
      if (snap.exists()) {
        leagueData = snap.data();
      } else {
        // İlk kurulum: boş data yaz
        await setDoc(leagueDocRef, leagueData, { merge: true });
      }
      // İlk render
      initializeGroups();
      populateGroupSelects();

      // Gerçek zamanlı dinleme (başkası güncelleyince herkese yansısın)
      unsub = onSnapshot(leagueDocRef, (docSnap) => {
        if (docSnap.exists()) {
          leagueData = docSnap.data();
          // UI'ı güncelle
          initializeGroups();
          populateGroupSelects();
          // Seçili sekmedeki tablo/fixtür varsa yenile
          if (document.getElementById('standings').classList.contains('active')) showStandings();
          if (document.getElementById('fixtures').classList.contains('active')) showFixtures();
        }
      });
    }

    // --- 4) Kimlik doğrulama (anonim) ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) await signInAnonymously(auth);
      await startRealtime();
    });

    // --- 5) Firestore'a yazma yardımcıları ---
    let saveTimer = null;
    function scheduleSave() {
      // Çok sık yazmayı önlemek için 400ms debounce
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        await setDoc(leagueDocRef, leagueData, { merge: true });
      }, 400);
    }

    // Global fonksiyonlar (HTML inline çağırıyor)
    window.updateGroupMember = (group, index, value) => {
      if (!leagueData.groups[group]) leagueData.groups[group] = [];
      leagueData.groups[group][index] = value;
      scheduleSave();
      populateGroupSelects();
    };

    window.saveGroups = () => {
      // Input'lardaki değerleri okumak için küçük bir tur
      document.querySelectorAll('#groups input[type="text"]').forEach((input) => {
        const oc = input.getAttribute('onchange');
        if (oc) { try { eval(oc.replace('this.value', `\'${input.value.replace(/'/g, "\\'")}\'`)); } catch(e){} }
      });
      scheduleSave();
      alert('✅ Gruplar başarıyla kaydedildi!');
      setTimeout(() => initializeGroups(), 100);
    };

    window.showBulkAdd = () => {
      populateGroupSelects();
      document.getElementById('bulkAddModal').classList.remove('hidden');
    };

    window.closeBulkAdd = () => {
      document.getElementById('bulkAddModal').classList.add('hidden');
      document.getElementById('bulkNamesInput').value = '';
      document.getElementById('bulkGroupSelect').value = '';
    };

    window.addBulkNames = () => {
      const group = document.getElementById('bulkGroupSelect').value;
      const namesText = document.getElementById('bulkNamesInput').value;
      if (!group) return alert('❌ Lütfen bir grup seçin!');
      if (!namesText.trim()) return alert('❌ Lütfen isimleri girin!');
      const names = namesText.split('\n').map(n => n.trim()).filter(Boolean);
      const maxCapacity = group === 'N' ? 6 : 8;
      if (names.length > maxCapacity) {
        alert(`❌ Grup ${group} maksimum ${maxCapacity} kişi alabilir! Siz ${names.length} kişi girdiniz.`);
        return;
      }
      if (!leagueData.groups[group]) leagueData.groups[group] = Array(maxCapacity).fill('');
      for (let i = 0; i < maxCapacity; i++) leagueData.groups[group][i] = names[i] || '';
      scheduleSave();
      initializeGroups();
      window.closeBulkAdd();
      alert(`✅ ${names.length} kişi Grup ${group}'ye başarıyla eklendi!`);
    };

    function generateFixtures(group) {
      const members = (leagueData.groups[group] || []).filter(m => m.trim() !== '');
      const n = members.length;
      if (n < 2) return [];
      const fixtures = [];
      const totalWeeks = n % 2 === 0 ? n - 1 : n;
      for (let week = 1; week <= totalWeeks; week++) fixtures.push({ week, matches: [] });
      let matchId = 0; const allMatches = [];
      for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
          allMatches.push({ id: `${group}_${matchId}`, home: members[i], away: members[j], homeScore: '', awayScore: '' });
          matchId++;
        }
      }
      let weekIndex = 0;
      for (const match of allMatches) {
        let placed = false, attempts = 0;
        while (!placed && attempts < totalWeeks) {
          const currentWeek = fixtures[weekIndex];
          const playersInWeek = new Set();
          currentWeek.matches.forEach(m => { playersInWeek.add(m.home); playersInWeek.add(m.away); });
          if (!playersInWeek.has(match.home) && !playersInWeek.has(match.away)) {
            currentWeek.matches.push(match); placed = true;
          }
          weekIndex = (weekIndex + 1) % totalWeeks; attempts++;
        }
      }
      return fixtures;
    }

    window.showFixtures = () => {
      const group = document.getElementById('fixtureGroupSelect').value;
      const content = document.getElementById('fixtureContent');
      if (!group) return (content.innerHTML = '<p class="text-gray-500">Lütfen bir grup seçin.</p>');
      if (!leagueData.fixtures[group]) leagueData.fixtures[group] = generateFixtures(group);
      const fixtures = leagueData.fixtures[group];
      content.innerHTML = `
        <div class="space-y-6">
          ${fixtures.map(week => `
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-bold text-lg mb-3 text-indigo-700">${week.week}. Hafta</h3>
              <div class="space-y-2">
                ${week.matches.map(match => `
                  <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded">
                    <span class="flex-1 text-right font-medium">${match.home}</span>
                    <input type="number" value="${leagueData.results[match.id]?.homeScore ?? ''}"
                      onchange="updateScore('${match.id}', 'homeScore', this.value)"
                      class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="text-gray-500">-</span>
                    <input type="number" value="${leagueData.results[match.id]?.awayScore ?? ''}"
                      onchange="updateScore('${match.id}', 'awayScore', this.value)"
                      class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="flex-1 font-medium">${match.away}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    };

    window.updateScore = (matchId, scoreType, value) => {
      if (!leagueData.results[matchId]) leagueData.results[matchId] = {};
      leagueData.results[matchId][scoreType] = value === '' ? '' : (parseInt(value) || 0);
      scheduleSave();
      const group = matchId.split('_')[0];
      if (document.getElementById('standingsGroupSelect').value === group) showStandings();
    };

    function calculateStandings(group) {
      const members = (leagueData.groups[group] || []).filter(m => m.trim() !== '');
      const standings = members.map(member => ({
        name: member, played: 0, won: 0, drawn: 0, lost: 0, correct: 0, wrong: 0, goalDifference: 0, points: 0
      }));
      Object.keys(leagueData.results || {}).forEach(matchId => {
        if (!matchId.startsWith(group + '_')) return;
        const result = leagueData.results[matchId];
        if (result?.homeScore === '' || result?.awayScore === '' || result?.homeScore == null || result?.awayScore == null) return;
        const homeScore = parseInt(result.homeScore) || 0;
        const awayScore = parseInt(result.awayScore) || 0;
        const fixtures = leagueData.fixtures[group] || [];
        let homeTeam, awayTeam;
        fixtures.forEach(week => week.matches.forEach(match => { if (match.id === matchId) { homeTeam = match.home; awayTeam = match.away; } }));
        if (!homeTeam || !awayTeam) return;
        const homeIndex = standings.findIndex(s => s.name === homeTeam);
        const awayIndex = standings.findIndex(s => s.name === awayTeam);
        if (homeIndex === -1 || awayIndex === -1) return;
        standings[homeIndex].played++; standings[awayIndex].played++;
        standings[homeIndex].correct += homeScore; standings[homeIndex].wrong += awayScore;
        standings[awayIndex].correct += awayScore; standings[awayIndex].wrong += homeScore;
        if (homeScore > awayScore) { standings[homeIndex].won++; standings[homeIndex].points += 3; standings[awayIndex].lost++; }
        else if (homeScore < awayScore) { standings[awayIndex].won++; standings[awayIndex].points += 3; standings[homeIndex].lost++; }
        else { standings[homeIndex].drawn++; standings[awayIndex].drawn++; standings[homeIndex].points++; standings[awayIndex].points++; }
        standings[homeIndex].goalDifference = standings[homeIndex].correct - standings[homeIndex].wrong;
        standings[awayIndex].goalDifference = standings[awayIndex].correct - standings[awayIndex].wrong;
      });
      standings.sort((a, b) => (b.points - a.points) || (b.goalDifference - a.goalDifference) || (b.correct - a.correct));
      return standings;
    }

    window.showStandings = () => {
      const group = document.getElementById('standingsGroupSelect').value;
      const content = document.getElementById('standingsContent');
      if (!group) return (content.innerHTML = '<p class="text-gray-500">Lütfen bir grup seçin.</p>');
      const standings = calculateStandings(group);
      const qualifyCount = group === 'N' ? 3 : 4;
      content.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="border border-gray-300 px-3 py-2 text-left">Sıra</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Öğrenci</th>
                <th class="border border-gray-300 px-3 py-2 text-center">O</th>
                <th class="border border-gray-300 px-3 py-2 text-center">G</th>
                <th class="border border-gray-300 px-3 py-2 text-center">B</th>
                <th class="border border-gray-300 px-3 py-2 text-center">M</th>
                <th class="border border-gray-300 px-3 py-2 text-center">D</th>
                <th class="border border-gray-300 px-3 py-2 text-center">Y</th>
                <th class="border border-gray-300 px-3 py-2 text-center">AV</th>
                <th class="border border-gray-300 px-3 py-2 text-center">P</th>
              </tr>
            </thead>
            <tbody>
              ${standings.map((team, index) => `
                <tr class="${index < qualifyCount ? 'qualified' : ''}">
                  <td class="border border-gray-300 px-3 py-2 font-bold">${index + 1}</td>
                  <td class="border border-gray-300 px-3 py-2 font-medium">${team.name}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.played}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.won}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.drawn}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.lost}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.correct}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.wrong}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.goalDifference > 0 ? '+' : ''}${team.goalDifference}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center font-bold">${team.points}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div class="mt-4 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-green-200 border border-green-300"></div>
              <span>Bir sonraki tura çıkan öğrenciler (İlk ${qualifyCount})</span>
            </div>
          </div>
        </div>
      `;
    };

    // Sekmeler
    window.showTab = (tabName, btn) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-indigo-600','border-b-2','border-indigo-600'); b.classList.add('text-gray-500'); });
      if (btn) { btn.classList.remove('text-gray-500'); btn.classList.add('text-indigo-600','border-b-2','border-indigo-600'); }
      if (tabName === 'standings') showStandings();
      if (tabName === 'fixtures') showFixtures();
      if (tabName === 'groups') { initializeGroups(); populateGroupSelects(); }
    };

    // İlk yüklemede grupları/menüleri oluştur (boş veriyle)
    document.addEventListener('DOMContentLoaded', () => {
      initializeGroups();
      populateGroupSelects();
    });
  </script>
</body>
</html>
