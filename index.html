<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematik Ligi Yönetim Sistemi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .qualified { background-color: #dcfce7 !important; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-4">
        <div class="text-4xl mr-4">🎒</div>
        <div class="text-center">
          <h1 class="text-3xl font-bold text-indigo-800 mb-2">🏆 Matematik Ligi</h1>
          <div class="text-center">
            <span class="text-gray-600 font-medium text-xl">Grup Aşaması</span>
          </div>
        </div>
        <div class="text-4xl ml-4">📚</div>
      </div>
      <div class="flex justify-center items-center space-x-4 text-2xl">
        <span>✏️</span><span>📝</span><span>🧮</span><span>📐</span><span>📏</span><span>🔢</span><span>➕</span><span>➖</span><span>✖️</span><span>➗</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="flex flex-wrap border-b">
        <button onclick="showTab('standings', this)" class="tab-btn px-4 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600">📊 Puan Durumu</button>
        <button onclick="showTabWithAuth('fixtures', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">📅 Fikstür 🔒</button>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-bold mb-4 text-center">🔒 Yönetici Girişi</h3>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Parola:</label>
            <input type="password" id="passwordInput" placeholder="Parolayı girin..." onkeypress="if(event.key==='Enter') submitPassword()" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" />
          </div>
          <p id="passwordError" class="text-red-600 text-sm mb-4 hidden">❌ Yanlış parola!</p>
          <div class="flex space-x-3">
            <button onclick="submitPassword()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">🔓 Giriş</button>
            <button onclick="closePasswordModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">❌ İptal</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Standings Tab -->
    <div id="standings" class="tab-content active">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Puan Durumu</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="standingsGroupSelect" onchange="showStandings()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div id="standingsContent"></div>
      </div>
    </div>

    <!-- Fixtures Tab (protected) -->
    <div id="fixtures" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Fikstür ve Sonuçlar</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="fixtureGroupSelect" onchange="showFixtures()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div class="mb-4 flex gap-2">
          <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm">💾 Yedeği İndir</button>
          <label class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm cursor-pointer">
            📤 Yedekten Yükle<input type="file" id="restoreInput" accept="application/json" class="hidden" onchange="restoreFromFile(event)" />
          </label>
        </div>
        <div id="fixtureContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Persisted State ----------
    let leagueData = { groups: {}, fixtures: {}, results: {} };

    // ---------- Auth (client-side only) ----------
    let isAuthenticated = false;
    let pendingTab = null;

    // Store only hash of password ("mat.asd")
    const PASSWORD_HASH = 'd91fc933c39c0f6ab74da0cfafd89d7b11342c8f3cb67bf2d5e0753553cc702b';

    async function sha256hex(str){
      const enc = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function showPasswordModal(){
      document.getElementById('passwordModal').classList.remove('hidden');
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').classList.add('hidden');
      setTimeout(()=>document.getElementById('passwordInput').focus(),0);
    }
    function closePasswordModal(){
      document.getElementById('passwordModal').classList.add('hidden');
    }
    async function submitPassword(){
      const val = document.getElementById('passwordInput').value;
      const ok = (await sha256hex(val)) === PASSWORD_HASH;
      if(ok){
        isAuthenticated = true;
        closePasswordModal();
        if(pendingTab){ showTab(pendingTab, null, true); pendingTab = null; }
        // 30 dk sonra otomatik kilit
        setTimeout(()=>{ isAuthenticated=false; alert('🔒 Oturum süresi doldu. Tekrar parola girmeniz gerekir.'); }, 30*60*1000);
      } else {
        document.getElementById('passwordError').classList.remove('hidden');
      }
    }

    function showTabWithAuth(tabName, btn){
      if(isAuthenticated){ showTab(tabName, btn); }
      else { pendingTab = tabName; showPasswordModal(); }
    }

    // ---------- Load / Save / Backup ----------
    function saveData(){
      try{
        localStorage.setItem('mathLeagueData', JSON.stringify(leagueData));
        // create/refresh hidden download link
        createDownloadableBackup();
      }catch(e){ console.error('Kaydetme hatası', e); alert('❌ Veriler kaydedilemedi!'); }
    }

    function loadData(){
      const saved = localStorage.getItem('mathLeagueData');
      if(saved){
        try{ leagueData = JSON.parse(saved) || leagueData; }
        catch(e){ console.error('Veri parse hatası', e); leagueData = { groups:{}, fixtures:{}, results:{} }; }
      } else {
        // İlk kurulum: verilen listelerle doldur
        seedInitialGroups();
        saveData();
      }
      initializeGroups();
      populateGroupSelects();
    }

    function createDownloadableBackup(){
      const dataStr = JSON.stringify(leagueData, null, 2);
      const blob = new Blob([dataStr], {type:'application/json'});
      let a = document.getElementById('downloadBackup');
      if(!a){ a = document.createElement('a'); a.id='downloadBackup'; a.style.display='none'; document.body.appendChild(a); }
      a.href = URL.createObjectURL(blob);
      a.download = `matematik_ligi_yedek_${new Date().toISOString().slice(0,10)}.json`;
    }

    function downloadBackup(){
      const a = document.getElementById('downloadBackup');
      if(a) a.click();
    }
    function restoreFromFile(ev){
      const file = ev.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if(obj && obj.groups && obj.fixtures && obj.results){
            leagueData = obj; saveData();
            initializeGroups(); populateGroupSelects(); showStandings(); showFixtures();
            alert('✅ Yedekten geri yüklendi.');
          } else { alert('❌ Geçersiz yedek dosyası.'); }
        } catch(e){ alert('❌ Dosya okunamadı.'); }
        ev.target.value = '';
      };
      reader.readAsText(file);
    }

    // ---------- Initial Groups (from your list) ----------
    function seedInitialGroups(){
      leagueData.groups['A'] = ['BADE ŞAHİN','MEHMET YAMAN MUMCU','KERİM MERT POLAT','PARS ERTAŞ','MERT RIZGAR YEŞİLMEN','ELİF SARE GENÇALP','MERT ALİ ÜNLÜ','KEREM SAYAR'];
      leagueData.groups['B'] = ['MİRA TEMÜR','KUZEY PEKŞEN','YUSUF GÖKALP SAKARYA','LİLA ERGÜN','DURU MİRA ÖDÜL','DEMİR ALİ KABAKTAŞ','EVİN İPEK ÖZGEN','EFE ÇAĞLAR'];
      leagueData.groups['C'] = ['CEM AKDENİZ','AYBÜKE ÜZE','ABDULLAH EFE ÖZTÜRK','EMİR MİRAS','KIVANÇ KARABULUT','EFE ATTEPE','ZUHAL UMAY ÇETİN','ALİ DEMİR ÇABUK'];
      leagueData.groups['D'] = ['SELİM SANCAK','BATU ŞAHİN','ARVEN TÜRK','TAN SOYÖZ','DERİN DEMİRKAYA','EYMEN ÖZDEMİR','MERT RIFAT ÇEBİ','ELİF ADRİANA OKUR'];
      leagueData.groups['E'] = ['MELİS MİRA OSMANBAŞ','DURU KÜÇÜKSÜMBÜL','HALİL İBRAHİM BAYSOY','TANEM DENİZ MERTLER','POYRAZ ÜNGÜDER','RABİA BAHAR ÇAN','İNCİ JANSELİ KAVAL','BARIŞ TOKGÖZ'];
      leagueData.groups['F'] = ['SELEN IŞIK','AYSAN SEIFZADEH','DENİZ ÇAKIR','DOĞUKAN KILIÇ','DOĞUKAN ARSLAN','ALİ KAAN MERCAN','MEHMET ÇAĞAN KIZILOĞLU','ALYA SENA ÇİÇEK'];
      leagueData.groups['G'] = ['EMİRCAN RAHİMOĞLU','SARP BALCIOĞLU','BATU DURUKAN','ELİS TEKE','KENAN SARP ÇÖTE','SEVİNÇ ECE BİLGİÇ','NASRİ ÇİÇEK','CEVDET AKİF TOKLU'];
      leagueData.groups['H'] = ['ARHAN AKARSU','ANIL CANSU YILMAZ','ASYA MİNA ÖZ','AYŞE ÖYKÜ YILDIRIM','MİRA GÖZENER','NİL ERSAN','KEREM TEKİN','DERİN SINEF DİN'];
      leagueData.groups['I'] = ['YAĞMUR ELİF BİNGÖL','CANSU YILMAZ','ATLAS BAHADIR','MİRA İNECİ','BERAT AĞIRMAN','KEREM ÖZTÜRK','CEMAL SALMANLI','ARES DOĞAN'];
      leagueData.groups['J'] = ['DERİN BOZKURT','ASYA KARAMAN','DENİZ GÖKSU','BELİZ SU BAŞARSLAN','YUSUF EFE KARAGÖZOĞLU','İPEK NİSA KOÇBAY','İPEK PAPİN','PELİN USTA'];
      leagueData.groups['K'] = ['SARP SALİHOĞLU','SARE YILMAZ','KUZEY MERT YILMAZ','ZEYNEP ARSLAN','BARDIA ESHRATABADY','ERDAL ATİLLA ŞAKAR','MİRZA ÖZBEKLİ','AYAZ ALİ YILDIRIM'];
      leagueData.groups['L'] = ['BERKEN AREL AYAZ','ÖMER KALEBAŞ','ECE NUR EGE','KERİM KARKIN','EGEMEN ÇALIŞKAN','YAĞIZ AVCI','DERİN YALÇINKAYA','ATLAS DENİZ ÇELİK'];
      leagueData.groups['M'] = ['DENİZ EROL BAŞARSLAN','ÖYKÜ CAP','ECE KÜÇÜKDALGIÇ','NAZLI USKUÇ','KAYRA GÖZÜBÜYÜK','YAŞAR YAMAN YOLCU','İLAY MELEK MEYDAN','AYŞE SERRA KARTAL'];
      leagueData.groups['N'] = ['ALP ALTINTAŞ','ADA ERAKPINAR','BADE SEZGİN','DORUK DOĞAN','DURU SAĞDIÇ','ELA YILMAZ'];
    }

    // ---------- UI helpers ----------
    function initializeGroups(){
      const letters = 'ABCDEFGHIJKLMN'.split('');
      letters.forEach(letter => {
        const cap = letter === 'N' ? 6 : 8;
        if(!leagueData.groups[letter]) leagueData.groups[letter] = Array(cap).fill('');
      });
    }

    function populateGroupSelects(){
      const fixtureSelect = document.getElementById('fixtureGroupSelect');
      const standingsSelect = document.getElementById('standingsGroupSelect');
      fixtureSelect.innerHTML = '<option value="">Grup seçin...</option>';
      standingsSelect.innerHTML = '<option value="">Grup seçin...</option>';
      const letters = 'ABCDEFGHIJKLMN'.split('');
      letters.forEach(g => {
        const hasMember = (leagueData.groups[g]||[]).some(n=>n && n.trim()!=='');
        if(hasMember){
          const o1 = document.createElement('option'); o1.value=g; o1.textContent='Grup '+g; fixtureSelect.appendChild(o1);
          const o2 = document.createElement('option'); o2.value=g; o2.textContent='Grup '+g; standingsSelect.appendChild(o2);
        }
      });
    }

    function generateFixtures(group){
      const members = (leagueData.groups[group]||[]).filter(m=>m.trim()!=='');
      const n = members.length; if(n<2) return [];
      const fixtures = []; const totalWeeks = n%2===0 ? n-1 : n;
      for(let w=1; w<=totalWeeks; w++) fixtures.push({week:w, matches:[]});
      let matchId=0; const all=[];
      for(let i=0;i<n;i++) for(let j=i+1;j<n;j++) all.push({id:`${group}_${matchId++}`,home:members[i],away:members[j]});
      let wi=0; for(const m of all){ let placed=false, tries=0; while(!placed&&tries<totalWeeks){ const week=fixtures[wi]; const used=new Set(); week.matches.forEach(x=>{used.add(x.home);used.add(x.away);}); if(!used.has(m.home)&&!used.has(m.away)){ week.matches.push({...m}); placed=true; } wi=(wi+1)%totalWeeks; tries++; } }
      return fixtures;
    }

    function showFixtures(){
      const group = document.getElementById('fixtureGroupSelect').value;
      const content = document.getElementById('fixtureContent');
      if(!group){ content.innerHTML = '<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      if(!leagueData.fixtures[group]) leagueData.fixtures[group] = generateFixtures(group);
      const fixtures = leagueData.fixtures[group];
      content.innerHTML = `
        <div class="space-y-6">
          ${fixtures.map(week=>`
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-bold text-lg mb-3 text-indigo-700">${week.week}. Hafta</h3>
              <div class="space-y-2">
                ${week.matches.map(match=>`
                  <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded">
                    <span class="flex-1 text-right font-medium">${match.home}</span>
                    <input type="number" value="${leagueData.results[match.id]?.homeScore ?? ''}" ${isAuthenticated?'':'disabled'}
                           onchange="updateScore('${match.id}','homeScore',this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1 ${isAuthenticated?'':'bg-gray-100 cursor-not-allowed'}">
                    <span class="text-gray-500">-</span>
                    <input type="number" value="${leagueData.results[match.id]?.awayScore ?? ''}" ${isAuthenticated?'':'disabled'}
                           onchange="updateScore('${match.id}','awayScore',this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1 ${isAuthenticated?'':'bg-gray-100 cursor-not-allowed'}">
                    <span class="flex-1 font-medium">${match.away}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function updateScore(matchId, key, val){
      if(!isAuthenticated){ alert('🔒 Skor girmek için parola gerekli.'); return; }
      if(!leagueData.results[matchId]) leagueData.results[matchId] = {};
      leagueData.results[matchId][key] = val==='' ? '' : (parseInt(val)||0);
      saveData();
      const group = matchId.split('_')[0];
      if(document.getElementById('standingsGroupSelect').value === group){ showStandings(); }
    }

    function calculateStandings(group){
      const members = (leagueData.groups[group]||[]).filter(m=>m.trim()!=='');
      const table = members.map(n=>({name:n,played:0,won:0,drawn:0,lost:0,correct:0,wrong:0,goalDifference:0,points:0}));
      Object.keys(leagueData.results||{}).forEach(id=>{
        if(!id.startsWith(group+'_')) return;
        const r = leagueData.results[id];
        if(r?.homeScore===''||r?.awayScore===''||r?.homeScore==null||r?.awayScore==null) return;
        const homeScore = parseInt(r.homeScore)||0, awayScore=parseInt(r.awayScore)||0;
        const fx = leagueData.fixtures[group]||[]; let home,away;
        fx.forEach(w=>w.matches.forEach(m=>{ if(m.id===id){ home=m.home; away=m.away; } }));
        if(!home||!away) return; const hi=table.findIndex(s=>s.name===home), ai=table.findIndex(s=>s.name===away); if(hi<0||ai<0) return;
        table[hi].played++; table[ai].played++;
        table[hi].correct+=homeScore; table[hi].wrong+=awayScore; table[ai].correct+=awayScore; table[ai].wrong+=homeScore;
        if(homeScore>awayScore){ table[hi].won++; table[hi].points+=3; table[ai].lost++; }
        else if(homeScore<awayScore){ table[ai].won++; table[ai].points+=3; table[hi].lost++; }
        else { table[hi].drawn++; table[ai].drawn++; table[hi].points++; table[ai].points++; }
        table[hi].goalDifference = table[hi].correct - table[hi].wrong;
        table[ai].goalDifference = table[ai].correct - table[ai].wrong;
      });
      table.sort((a,b)=> (b.points-a.points) || (b.goalDifference-a.goalDifference) || (b.correct-a.correct));
      return table;
    }

    function showStandings(){
      const group = document.getElementById('standingsGroupSelect').value;
      const content = document.getElementById('standingsContent');
      if(!group){ content.innerHTML = '<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      const s = calculateStandings(group);
      const qualifyCount = group==='N' ? 3 : 4;
      content.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="border px-3 py-2 text-left">Sıra</th>
                <th class="border px-3 py-2 text-left">Öğrenci</th>
                <th class="border px-3 py-2 text-center">O</th>
                <th class="border px-3 py-2 text-center">G</th>
                <th class="border px-3 py-2 text-center">B</th>
                <th class="border px-3 py-2 text-center">M</th>
                <th class="border px-3 py-2 text-center">D</th>
                <th class="border px-3 py-2 text-center">Y</th>
                <th class="border px-3 py-2 text-center">AV</th>
                <th class="border px-3 py-2 text-center">P</th>
              </tr>
            </thead>
            <tbody>
              ${s.map((t,i)=>`
                <tr class="${i<qualifyCount?'qualified':''}">
                  <td class="border px-3 py-2 font-bold">${i+1}</td>
                  <td class="border px-3 py-2 font-medium">${t.name}</td>
                  <td class="border px-3 py-2 text-center">${t.played}</td>
                  <td class="border px-3 py-2 text-center">${t.won}</td>
                  <td class="border px-3 py-2 text-center">${t.drawn}</td>
                  <td class="border px-3 py-2 text-center">${t.lost}</td>
                  <td class="border px-3 py-2 text-center">${t.correct}</td>
                  <td class="border px-3 py-2 text-center">${t.wrong}</td>
                  <td class="border px-3 py-2 text-center">${t.goalDifference>0?'+':''}${t.goalDifference}</td>
                  <td class="border px-3 py-2 text-center font-bold">${t.points}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          <div class="mt-4 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-green-200 border border-green-300"></div>
              <span>Bir sonraki tura çıkan öğrenciler (İlk ${qualifyCount})</span>
            </div>
          </div>
        </div>`;
    }

    // ---------- Tabs ----------
    function showTab(tabName, btn, bypass=false){
      if(!bypass && tabName==='fixtures' && !isAuthenticated){ pendingTab=tabName; showPasswordModal(); return; }
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>{ b.classList.remove('text-indigo-600','border-b-2','border-indigo-600'); b.classList.add('text-gray-500'); });
      if(btn){ btn.classList.remove('text-gray-500'); btn.classList.add('text-indigo-600','border-b-2','border-indigo-600'); }
      if(tabName==='standings') showStandings();
      if(tabName==='fixtures') showFixtures();
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();
      createDownloadableBackup();
      // Varsayılan olarak ilk mevcut grubu seç
      const sel = document.getElementById('standingsGroupSelect');
      if(sel && sel.options.length>1) { sel.selectedIndex = 1; showStandings(); }
    });
  </script>
</body>
</html>
